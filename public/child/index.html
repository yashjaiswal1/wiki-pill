<!DOCTYPE html>
<html>
  <head>
    <title>WikiPills | Geofence</title>
    <meta name="viewport" content="initial-scale=1.0" />
    <meta charset="utf-8" />
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 95%;
        width: 74%;
        float: left;
        border: 15px;
      }
      /* Optional: Makes the sample page fill the window. */
      html,
      body {
        height: 100%;
        margin: 10px 0px 10px 10px;
        padding: 0;
      }
      #toast-container {
  top: auto !important;
  right: auto !important;
  bottom: 10%;
  left:7%;  
}
    </style>
    <!--Import Google Icon Font-->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <!-- Compiled and minified Materialize CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
    />
  </head>
  <body>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <div class="hoverable" id="map"></div>
    <!-- &NonBreakingSpace;&NonBreakingSpace;<button
      class="btn-floating btn-large waves-effect waves-light red hoverable"
      onclick="changeMarkerPosition(marker, map, poly, track)"
    >
      <i class="material-icons">
        autorenew
      </i>
    </button> -->
    
    <div class="row">
      <div class="col s3">
        <div class="card hoverable">
          <div class="card-content">
            <span class="card-title"><b>Control Panel</b></span>
              <ul style="float: left;">
                <li>- See History Log</li>
                <li>- Set Schedule</li>
                <li>- Share live location</li>
              </ul>
              <button
      class="btn-floating btn-large waves-effect waves-light red hoverable"
      onclick="changeMarkerPosition(marker, map, poly, track)" style="float: right;"
    >
      <!-- <i class="material-icons">
        autorenew
      </i> -->
      <i class="material-icons">location_on</i>
    </button>
          </div>
          <div class="card-tabs">
            <ul class="tabs">
              <li class="tab"><a href="#test4">History</a></li>
              <li class="tab"><a class="active" href="#test5">Schedule</a></li>
              <li class="tab"><a href="#test6">Share</a></li>
            </ul>
          </div>
        <div class="card-content grey lighten-4">
          <div id="test4"><table>
            <tbody>
              <tr id="tr1">
                <!-- <td>Region 1</td>
                <td></td>
                <td>$0.87</td> -->
              </tr>
              <tr id="tr2">
                <!-- <td>Alan</td>
                <td>Jellybean</td>
                <td>$3.76</td> -->
              </tr>
              <tr id="tr3">
                <!-- <td>Jonathan</td>
                <td>Lollipop</td>
                <td>$7.00</td> -->
              </tr>
              <tr id="tr4">
                <!-- <th>Place</th>
                <th>Time</th>
                <th>Arrival/Departure</th> -->
              </tr>
            </tbody>
          </table></div>
          <div id="test5">
             <input type="text" class="timepicker" placeholder="Start Time">
             <input type="text" class="timepicker" placeholder="End Time">
          </div>
          <div id="test6">Test 3</div>
          
        </div>
      </div>
    </div>
    <script>
      $(document).ready(function(){
        $('.tabs').tabs();
      });
      $(document).ready(function(){
    $('.timepicker').timepicker();
  });
    </script>
    <script>
      // Map with a marker
      /*var map;
      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: -34.397, lng: 150.644},
          zoom: 8
        });
        var marker = new google.maps.Marker({
            position: {lat: -34.397, lng: 150.644},
            map: map
        });
      }*/

      // Note: This example requires that you consent to location sharing when
      // prompted by your browser. If you see the error "The Geolocation service
      // failed.", it means you probably did not give permission for the browser to
      // locate you.
      var map,
        marker,
        infoWindow,
        markerLocation,
        poly,
        status,
        coordinates,
        track,
        counter = 0;
      var flag = 0;
      var queue = [];
      var temp;
      var i = -1;
      var j = 0, k, l = 1;
      var firebaseRef = firebase.database().ref();
      var notifRef = firebase.database().ref().child("Notifications");
      // status --> false, when outside geofenced area
      // status --> true, when inside geofenced area
      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 13.115893, lng: 77.635558 },
          zoom: 17,
        });

        marker = new google.maps.Marker({
          map: map,
          draggable: true,
          animation: google.maps.Animation.DROP,
          position: { lat: 13.117233, lng: 77.63485 },
        });

        var markerLat = marker.position.lat();
        var markerLng = marker.position.lng();
        var markerLocation = new google.maps.LatLng(markerLat, markerLng);
        coordinates = [
          {
            lat: markerLat,
            lng: markerLng,
          },
        ];
        track = new google.maps.Polyline({
          path: coordinates,
          geodesic: true,
          strokeColor: "#6270E4",
          strokeOpacity: 1,
          strokeWeight: 5,
        });

        track.setMap(map);

        //         infoWindow = new google.maps.InfoWindow;

        //         // Try HTML5 geolocation.
        //         if (navigator.geolocation) {
        //           navigator.geolocation.getCurrentPosition(function(position) {
        //             var pos = {
        //               lat: position.coords.latitude,
        //               lng: position.coords.longitude
        //             };

        //             infoWindow.setPosition(pos);
        //             infoWindow.setContent('Location found.');
        //             infoWindow.open(map);
        //             map.setCenter(pos);
        //           }, function() {
        //             handleLocationError(true, infoWindow, map.getCenter());
        //           });

        //         } else {
        //           // Browser doesn't support Geolocation
        //           handleLocationError(false, infoWindow, map.getCenter());
        //         }
        
        var drawingManager = new google.maps.drawing.DrawingManager({
          drawingMode: google.maps.drawing.OverlayType.MARKER,
          drawingControl: true,
          drawingControlOptions: {
            position: google.maps.ControlPosition.TOP_CENTER,
            drawingModes: ["polygon"],
          },
        });
        drawingManager.setMap(map);
        google.maps.event.addListener(
          drawingManager,
          "overlaycomplete",
          function (polygon) {
            console.log("OLA");
            var coordinatesArray = polygon.overlay.getPath().getArray();
            poly = new google.maps.Polygon({
              paths: [
                new google.maps.LatLng(
                  coordinatesArray[0].lat(),
                  coordinatesArray[0].lng()
                ),
                new google.maps.LatLng(
                  coordinatesArray[1].lat(),
                  coordinatesArray[1].lng()
                ),
                new google.maps.LatLng(
                  coordinatesArray[2].lat(),
                  coordinatesArray[2].lng()
                ),
                new google.maps.LatLng(
                  coordinatesArray[3].lat(),
                  coordinatesArray[3].lng()
                ),
              ],
            });
            i += 1;
            queue[i] = poly;
            
            poly = queue[j];
            var firebaseRef = firebase.database().ref();
            var notifRef = firebase.database().ref().child("Notifications");
            // console.log("Initial Check: " + checkIfInside(poly, markerLocation));
            status = checkIfInside(poly, markerLocation);
            //when polygon is completed, below code block is executed
            if (status == "true") {
              // functions when point is inside polygon
              console.log("inside region 1");
              flag = 1;
              notifRef.set(0);
            } if(status == "false" && flag) {
              // functions when point is outside polygon
              console.log("outside region 1");
              j += 1;
              poly = queue[j];
              notifRef.set(1);
              flag = 0;
            }

            // var c = google.maps.geometry.poly.containsLocation(markerLocation, poly);
            // console.log(c);
            // // console.log("Working!\n");
            // console.log(coordinatesArray);
            // console.log(coordinatesArray[0].lat());
          }
        );
      }

      function checkIfInside(poly, markerLocation) {
        return google.maps.geometry.poly.containsLocation(markerLocation, poly);
      }

      function changeMarkerPosition(marker, map, poly, track) {
        var firebaseRef = firebase.database().ref();
        var notifRef = firebase.database().ref().child("Notifications");
        //2nd button press
        if (counter == 0) {
          var latlng = new google.maps.LatLng(13.117225, 77.633982);
          marker.setPosition(latlng);
          // console.log(
          //   checkIfInside(poly, new google.maps.LatLng(13.117225, 77.633982))
          // );

          status = checkIfInside(
            poly,
            new google.maps.LatLng(13.117225, 77.633982)
          );
          var path = track.getPath();
          path.push(new google.maps.LatLng(13.117225, 77.633982));
          // console.log(path);
          counter += 1;
          // console.log("Status value = " + status);
          // console.log(typeof status);
          if (status == "true") {
            // functions when point is inside polygon
            console.log("Working 1");
            k = j+1;
            console.log("inside region " + k + " LOLZZZ");
            M.toast({html: 'Inside Region ' + k, classes: 'rounded green'});
            temp = document.createElement("TD");
            temp.innerHTML = "Entered region " + k + " at " + new Date();
            document.getElementById("tr" + l).appendChild(temp);
            l += 1;
            notifRef.set(0);
            flag = 1;
          } if(flag && status == "false") {
            // functions when point is outside polygon 1
            k = j+1;
            console.log("outside region " + k);
            M.toast({html: 'Outside Region ' + k, classes: 'rounded red'});
            temp = document.createElement("TD");
            temp.innerHTML = "Departed from region " + k + " at " + new Date();
            document.getElementById("tr" + l).appendChild(temp);
            l += 1;
            j += 1;
            poly = queue[j];
            notifRef.set(1);
            flag = 0;
            
          }
        }
        //3rd button press
        else if (counter == 1) {
          console.log("TEST");
          var latlng = new google.maps.LatLng(13.117646, 77.633977);
          marker.setPosition(latlng);
          // console.log(
          //   checkIfInside(poly, new google.maps.LatLng(13.117646, 77.633977))
          // );
          if(queue.length > 1){
          status = checkIfInside(
            queue[j],   //for > 1 geofence, this will work
            new google.maps.LatLng(13.117646, 77.633977)
          );
          }
          if(queue.length == 1){
          status = checkIfInside(
            queue[0],   //for 1 geofence, this will work
            new google.maps.LatLng(13.117646, 77.633977)
          );
          }
          var path = track.getPath();
          path.push(new google.maps.LatLng(13.117646, 77.633977));
          // console.log(path);
          counter += 1;
          console.log("TEST");    
          if (status == "true") {
            // functions when point is inside polygon
            k = j+1;
            console.log("inside region " + k);
            M.toast({html: 'Inside Region ' + k, classes: 'rounded green'});
            temp = document.createElement("TD");
            temp.innerHTML = "Entered region " + k + " at " + new Date();
            document.getElementById("tr" + l).appendChild(temp);
            l += 1;
            notifRef.set(0);
            flag = 1;
          } if(flag && status == "false") {
            // functions when point is outside polygon
            k = j+1;
            console.log("outside region " + k);
            M.toast({html: 'Outside Region ' + k, classes: 'rounded red'});
            temp = document.createElement("TD");
            temp.innerHTML = "Departed from region " + k + " at " + new Date();
            document.getElementById("tr" + l).appendChild(temp);
            l += 1;
            j += 1;
            poly = queue[j];
            notifRef.set(1);
            flag = 0;
          }
          //4th button press
        } else if (counter == 2) {
          var latlng = new google.maps.LatLng(13.11778, 77.63311);
          marker.setPosition(latlng);
          // console.log(
          //   checkIfInside(queue[j], new google.maps.LatLng(13.11778, 77.63311))
          // );
          // console.log(queue[j]);
          if(queue.length > 1){
          status = checkIfInside(
            queue[j],
            new google.maps.LatLng(13.11778, 77.63311)
          );
          }
          if(queue.length == 1){
          status = checkIfInside(
            queue[0],
            new google.maps.LatLng(13.11778, 77.63311)
          );
          }
          var path = track.getPath();
          path.push(new google.maps.LatLng(13.11778, 77.63311));
          // console.log(path);
          counter += 1;
          if (status == "true") {
            // functions when point is inside polygon
            k = j+1;
            console.log("inside region " + k);
            M.toast({html: 'Inside Region ' + k, classes: 'rounded green'});
            temp = document.createElement("TD");
            temp.innerHTML = "Entered region " + k + " at " + new Date();
            document.getElementById("tr" + l).appendChild(temp);
            l += 1;
            notifRef.set(0);
            flag = 1;
          } if(flag && status == "false"){
            // functions when point is outside polygon
            k = j+1;
            console.log("outside region " + k);
            M.toast({html: 'Outside Region ' + k, classes: 'rounded red'});
            temp = document.createElement("TD");
            temp.innerHTML = "Departed from region " + k + " at " + new Date();
            document.getElementById("tr" + l).appendChild(temp);
            l += 1;
            j += 1;
            poly = queue[j]
            notifRef.set(1);
            flag = 0;
          }
        }
        //   track.setPath(path);
      }

      //   function handleLocationError(browserHasGeolocation, infoWindow, pos) {
      //     infoWindow.setPosition(pos);
      //     infoWindow.setContent(browserHasGeolocation ?
      //                           'Error: The Geolocation service failed.' :
      //                           'Error: Your browser doesn\'t support geolocation.');
      //     infoWindow.open(map);
      //   }
    </script>
    <script
      async
      defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCUVLVDzVTA5YLe3HjYdnDYzVlMpjwShgc&libraries=geometry,drawing&callback=initMap"
      async
      defer
    ></script>
    
    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <!-- Firebase -->
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="/__/firebase/7.9.1/firebase-app.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
      https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="/__/firebase/7.9.1/firebase-database.js"></script>

    <!-- Initialize Firebase -->
    <script src="/__/firebase/init.js"></script>
    <script src="../index.js"></script>
  </body>
</html>
