<!DOCTYPE html>
<html>
  <head>
    <title>WikiPills | Geofence</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 10px;
        padding: 0;
      }
    </style>
  </head>
  <body>
      <button onclick="changeMarkerPosition(marker, map, poly, track)">Change Coordinates</button>
    <div id="map"></div>
    <script>
      // Map with a marker
      /*var map;
      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: -34.397, lng: 150.644},
          zoom: 8
        });
        var marker = new google.maps.Marker({
            position: {lat: -34.397, lng: 150.644},
            map: map
        });
      }*/
      
      // Note: This example requires that you consent to location sharing when
      // prompted by your browser. If you see the error "The Geolocation service
      // failed.", it means you probably did not give permission for the browser to
      // locate you.
      var map, marker, infoWindow, markerLocation, poly, status, coordinates, track, counter=0;
      var firebaseRef = firebase.database().ref();
      var notifRef = firebase.database().ref().child("Notifications");
      // status --> false, when outside geofenced area
      // status --> true, when inside geofenced area
      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 13.1285, lng: 77.5873},
          zoom: 17
        });

        marker = new google.maps.Marker({
          map: map,
          draggable: true,
          animation: google.maps.Animation.DROP,
          position: {lat: 13.128260, lng: 77.588138}
        });

        var markerLat = marker.position.lat();
        var markerLng = marker.position.lng();
        var markerLocation = new google.maps.LatLng(markerLat, markerLng);
        coordinates = [
            {
                lat: markerLat, lng: markerLng
            }
        ];
        track = new google.maps.Polyline({
            path: coordinates,
            geodesic: true,
            strokeColor: '#6270E4',
            strokeOpacity: 1,
            strokeWeight: 5
        });

        track.setMap(map);



//         infoWindow = new google.maps.InfoWindow;

//         // Try HTML5 geolocation.
//         if (navigator.geolocation) {
//           navigator.geolocation.getCurrentPosition(function(position) {
//             var pos = {
//               lat: position.coords.latitude,
//               lng: position.coords.longitude
//             };

//             infoWindow.setPosition(pos);
//             infoWindow.setContent('Location found.');
//             infoWindow.open(map);
//             map.setCenter(pos);
//           }, function() {
//             handleLocationError(true, infoWindow, map.getCenter());
//           });

//         } else {
//           // Browser doesn't support Geolocation
//           handleLocationError(false, infoWindow, map.getCenter());
//         }

    var drawingManager = new google.maps.drawing.DrawingManager({
    drawingMode: google.maps.drawing.OverlayType.MARKER,
    drawingControl: true,
    drawingControlOptions: {
      position: google.maps.ControlPosition.TOP_CENTER,
      drawingModes: [ 'polygon']
    }
  });
  drawingManager.setMap(map);
  google.maps.event.addListener(drawingManager, 'overlaycomplete', function(polygon) {
    var coordinatesArray = polygon.overlay.getPath().getArray();
    
    poly = new google.maps.Polygon({
        paths: [
            new google.maps.LatLng(coordinatesArray[0].lat(),coordinatesArray[0].lng()),
            new google.maps.LatLng(coordinatesArray[1].lat(),coordinatesArray[1].lng()),
            new google.maps.LatLng(coordinatesArray[2].lat(),coordinatesArray[2].lng()),
            new google.maps.LatLng(coordinatesArray[3].lat(),coordinatesArray[3].lng())
        ]
    });

    var firebaseRef = firebase.database().ref();
    var notifRef = firebase.database().ref().child("Notifications");
    console.log(checkIfInside(poly, markerLocation));
    status = checkIfInside(poly, markerLocation);
    if(status){               // functions when point is inside polygon
      console.log("inside");
      notifRef.set(0);
    }else{                    // functions when point is outside polygon
      console.log("outside");
      notifRef.set(1);
    }
    
    

    
    // var c = google.maps.geometry.poly.containsLocation(markerLocation, poly);
    // console.log(c);
    // // console.log("Working!\n");
    // console.log(coordinatesArray);
    // console.log(coordinatesArray[0].lat());
});        

      }
      
      function checkIfInside(poly, markerLocation){
        return (google.maps.geometry.poly.containsLocation(markerLocation, poly));
    }

      function changeMarkerPosition(marker, map, poly, track){
        var firebaseRef = firebase.database().ref();
        var notifRef = firebase.database().ref().child("Notifications");
        if(counter == 0){
          var latlng = new google.maps.LatLng(13.130743,77.588444);
          marker.setPosition(latlng);
          console.log(checkIfInside(poly, new google.maps.LatLng(13.130743, 77.588444)));
          status = checkIfInside(poly, new google.maps.LatLng(13.130743, 77.588444));
          var path = track.getPath();
          path.push(new google.maps.LatLng(13.130743, 77.588444));
          console.log(path);
          counter += 1;
          if(!status){               // functions when point is inside polygon
            console.log("inside");
            notifRef.set(0);
          }else{                    // functions when point is outside polygon
            console.log("outside");
            notifRef.set(1);
          }
        }else if(counter == 1){
          var latlng = new google.maps.LatLng(13.130731,77.590112);
          marker.setPosition(latlng);
          console.log(checkIfInside(poly, new google.maps.LatLng(13.130731, 77.590112)));
          status = checkIfInside(poly, new google.maps.LatLng(13.130731, 77.590112));
          var path = track.getPath();
          path.push(new google.maps.LatLng(13.130731, 77.590112));
          console.log(path);
          counter += 1;
          if(!status){               // functions when point is inside polygon
            console.log("inside");
            notifRef.set(0);
          }else{                    // functions when point is outside polygon
            console.log("outside");
            notifRef.set(1);
          }          
        }else if(counter == 2){
          var latlng = new google.maps.LatLng(13.129237,77.591035);
          marker.setPosition(latlng);
          console.log(checkIfInside(poly, new google.maps.LatLng(13.129237, 77.591035)));
          status = checkIfInside(poly, new google.maps.LatLng(13.129237, 77.591035));
          var path = track.getPath();
          path.push(new google.maps.LatLng(13.129237, 77.591035));
          console.log(path);
          counter += 1;
          if(!status){               // functions when point is inside polygon
            console.log("inside");
            notifRef.set(0);
          }else{                    // functions when point is outside polygon
            console.log("outside");
            notifRef.set(1);
          }          
        }
        //   track.setPath(path);
      }

    //   function handleLocationError(browserHasGeolocation, infoWindow, pos) {
    //     infoWindow.setPosition(pos);
    //     infoWindow.setContent(browserHasGeolocation ?
    //                           'Error: The Geolocation service failed.' :
    //                           'Error: Your browser doesn\'t support geolocation.');
    //     infoWindow.open(map);
    //   }


      
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCUVLVDzVTA5YLe3HjYdnDYzVlMpjwShgc&libraries=geometry,drawing&callback=initMap"
    async defer></script>
<!-- Firebase -->
 <!-- The core Firebase JS SDK is always required and must be listed first -->
 <script src="/__/firebase/7.9.1/firebase-app.js"></script>

 <!-- TODO: Add SDKs for Firebase products that you want to use
      https://firebase.google.com/docs/web/setup#available-libraries -->
 <script src="/__/firebase/7.9.1/firebase-database.js"></script>
 
 <!-- Initialize Firebase -->
 <script src="/__/firebase/init.js"></script>
  <script src="../index.js"></script>
  </body>
</html>